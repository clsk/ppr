<% # Inicializando las variables %>
<% days= 0 %>
<% entries= UserScheduleEntry.where(user_id: user.id) %>
<% names= ["Sun", "Mon", "Tues", "Wed", "Thu", "Fri", "Sat"] %>

<% # Itera sobre cada entrada que tenga el usuario %>
<% entries.each do |entry| %>
    <% days= (days | entry.days_of_week) %>
<% end %>

<% # Convierte el entero a la cadena de bits correspondiente %>
<% days= days.to_s(2) %>
<% days= ("0" * (7 - days.length)) + days %>

<fieldset id="user_schedule_entries_field_set" class="box tabular">
    <legend>Schedule</legend>
    <div class="splitcontentleft">
        <% # Imprime un checkbox por cada dia de la semana %>
        <% # Los dias que ya esten establecidos apareceran desactivados %>
        <% (0..6).each do |i| %>
            <% checked= (days[i] == "1" ? true : false) %>
            <%= check_box_tag "user_schedule_entry_day", (2 ** ((i - 6).abs)), checked, disabled: checked, id: ("user_schedule_entry_day_" + names[i]) %>
            <%= names[i] %>
            <br>
        <% end %>
        <br>
        <strong>Hours</strong>
        <%= text_field_tag "user_schedule_entry_hours_text_box", nil, size: 2 %>
        <input id="user_schedule_entry_add_button" type="button" value="Add" onClick="AddEntry()">
    </div>
    <div class="splitcontentright">
        <table id="user_schedule_entries_table">
            <% # Imprime cada entrada del usuario como una fila de la tabla %>
            <% entries.each do |entry| %>
                <%= content_tag :tr, :id=> entry.days_of_week do %>
                    <%= content_tag :td do %>
                        <% result= "" %>
                        <% # Concatena los nombres de los dias que sean necesarios %>
                        <% (0..6).each do |i| %>
                            <% result+= names[i] + "," if days[i] == "1" %>
                        <% end %>
                        <%= result.gsub(/,$/, "") %>
                    <% end %>
                    <%= content_tag :td, entry.hours, :class=> "user_schedule_entry_hours" %>
                    <%= content_tag :td, "X", :class=> "user_schedule_entry_remove_button" %>
                <% end %>
            <% end %>
        </table>
    </div>
</fieldset>
<script>
//$("#user_form div:nth-child(1)").append($("#user_schedule_entries_field_set"));

function GetDaysNames() {
    return ["Sun", "Mon", "Tues", "Wed", "Thu", "Fri", "Sat"];
}
function DaysToString(days) {
    var str_days= days.toString(2);
    return Array((7 - str_days.length) + 1).join("0") + str_days;
}

function AddEntry() {
    var days= 0;
    var hours= parseInt($.trim($("#user_schedule_entry_hours_text_box").val()));

    $('input[type="checkbox"][name="user_schedule_entry_day"]').each(function () {
        if($(this).is(":not(:disabled):checked")) {
            $(this).attr("disabled", true);

            days+= parseInt($.trim($(this).val()));
        }
    });

    if(days > 0 && hours > 0) {
        var entry= "";
        var names= GetDaysNames();
        var str_days= DaysToString(days);

        for(var i= 0; i < str_days.length; i++) {
            if(str_days[i] === "1") {
                entry+= names[i] + ",";
            }
        }

        entry= '<tr id="' + days + '"><td>' + entry.replace(/,$/, "") + '</td><td class="user_schedule_entry_hours">' + hours + '</td><td class="user_schedule_entry_remove_button">X</td></tr>';

        $("#user_schedule_entries_table").append(entry);
        $("#user_schedule_entry_hours_text_box").val("");
    }
    else {
        alert("Failed adding an entry!");
    }
}

$("#user_schedule_entries_table").on("click", "td.user_schedule_entry_remove_button", function() {
    var checkbox;
    var names= GetDaysNames();
    var tr= $(this).parent("tr");
    var str_days= DaysToString(parseInt($(tr).attr("id")));

    for(var i= 0; i < str_days.length; i++) {
        if(str_days[i] === '1') {
            checkbox= $("#user_schedule_entry_day_" + names[i]);

            checkbox.attr("checked", false);
            checkbox.attr("disabled", false);
        }
    }

    tr.remove();
    $("#user_schedule_entry_hours_text_box").val("");
});

function LoadEntries() {
    var days;
    var hours;
    var entries= {};

    $("#user_schedule_entries_table tr").each(function () {
        days= parseInt($(this).attr("id"));
        hours= parseInt($(this).children("td.user_schedule_entry_hours").text());

        entries[days]= hours;
    });

    return entries;
}

$(document).on("click", 'input[name="commit"]', function() {
    console.log(JSON.stringify(LoadEntries()));

    $.ajax({
        url: "<%= create2_user_schedule_entry_path(user_id: user.id) %>",
        type: "GET",
        dataType: "json",
        data: { "entries": JSON.stringify(LoadEntries()) }, // This goes to Controller in params hash, i.e. params[:file_name]
        success: function(data, textStatus, xhr) {
            alert("Registros actualizados exitosamente");
        },
        error: function() {
            alert("Ajax error!");
        }
  });
});
</script>
